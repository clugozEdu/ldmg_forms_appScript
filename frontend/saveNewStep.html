<script>
  let stepNewObject = [];
  let currentCodeStepNew = null;
  let currentRowEditNewStep = null;

  function saveNewStep() {
    let lastCodeStep = getMaxStepCodeFromTable();

    // add step in the table
    const tableBody = document.getElementById("table-body-steps");
    const row = document.createElement("tr");

    let newStepObject = {
      originalCode: lastCodeStep.toString(),
      mySQLFormId: idSelected,
      title: document.getElementById("title-step-new").value,
      description: document.getElementById("step-description").value,
      stepCode: lastCodeStep.toString(),
      type: document.getElementById("type-step-new").value,
      action: document.getElementById("action-step-new").value,
      question: document.getElementById("question-step-new").value,
      answerType: document.getElementById("answer-type-step-new").value,
      answer1: document.getElementById("answer-1-step-new").value,
      answer2: document.getElementById("answer-2-step-new").value,
      answer3: document.getElementById("answer-3-step-new").value,
      answer4: document.getElementById("answer-4-step-new").value,
      photo1: "",
      photo2: "",
      photo3: "",
      video1: "",
      video2: "",
      video3: "",
      status: "",
      checked: false,
      background: "",
    };

    //row.dataset.statusCode = "CodeOriginal";
    row.dataset.statusNew = "newStep";
    row.dataset.title = newStepObject.title;

    // flags to validate if new step
    row.dataset.stepCodeOriginal = newStepObject.stepCode;

    const exitstingStepIndex = stepNewObject.findIndex(
      (step) => step.originalCode === row.dataset.stepCodeOriginal
    );

    if (exitstingStepIndex > -1) {
      stepNewObject[exitstingStepIndex] = newStepObject;
    } else {
      stepNewObject.push(newStepObject);
    }

    //Object save new step
    const rowStepCode = createTableCell("10%", newStepObject.stepCode);
    const rowStepTitle = createTableCell("30%", newStepObject.title);
    const rowFormActionsCell = createTableCell("15%");

    const maxDescriptionLength = 80;
    const truncatedDescription =
      newStepObject.description.slice(0, maxDescriptionLength) + "...";
    const rowStepDescription = createTableCell("45%", truncatedDescription);
    const rowStepActions = createTableCell("15%");

    createAndAppendButtons(
      rowStepDescription,
      newStepObject.description,
      truncatedDescription,
      rowFormActionsCell,
      "btn-select-step-new",
      "btn-edit-step-new",
      "btn-delete-step-new"
    );

    [rowStepCode, rowStepTitle, rowStepDescription, rowFormActionsCell].forEach(
      (cell) => {
        row.appendChild(cell);
      }
    );

    tableBody.appendChild(row);

    updateStepCodes();

    initEditNewStep();
    initviewStepNew();
    initDeleteStepNew();
    dragDropTable();
    resetFormStep();

    const modal = document.getElementById("new-form-step");
    const modalIntance = bootstrap.Modal.getInstance(modal);
    modalIntance.hide();
  }
</script>
