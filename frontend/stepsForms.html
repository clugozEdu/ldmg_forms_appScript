<script>
  let idSelected;
  let isSaveFormStepEvent = false;
  let objectStep;

  function initEventButtonSelect() {
    const selectButtons = document.querySelectorAll(".btn-select");
    selectButtons.forEach((button) => {
      button.addEventListener("click", () => {
        showLoading();
        openModalSelectedForm();

        // const row = button.closest("tr");
        // const rowData = row.querySelectorAll("td");

        // idSelected = rowData[3].dataset.id;

        idSelected = "6b636f91";

        google.script.run
          .withSuccessHandler((object) => {
            if (object?.length > 0) {
              objectStep = object;
              setDataInTable(object);
            } else {
              hiddenLoading();
              swalWithBootstrapButtons.fire({
                title: "Error!",
                html: `<P>There was an error loading the steps</P>`,
                icon: "error",
                confirmButtonText: "Ok",
              });
            }
          })
          .getAFormStepsList(idSelected);
      });
    });
  }

  function setDataInTable(objectStep) {
    const tableBody = document.getElementById("table-body-steps");
    tableBody.innerHTML = "";

    hiddenLoading();

    let idMysqlValue = idSelected;

    objectStep.sort((a, b) => {
      const stepCodeA = parseInt(a.stepCode);
      const stepCodeB = parseInt(b.stepCode);

      if (stepCodeA < stepCodeB) {
        return -1;
      } else if (stepCodeA > stepCodeB) {
        return 1;
      } else {
        return 0;
      }
    });

    objectStep.forEach((steps, index) => {
      const row = document.createElement("tr");
      row.dataset.idMysql = steps.mySQLId;
      row.dataset.stepCodeOriginal = steps.stepCode;
      row.dataset.statusCode = "CodeOriginal";
      row.dataset.statusEdit = false;

      const stepCode = createTableCell("10%", steps.stepCode);
      //stepCode.dataset.idMysql = steps.mySQLId;

      const stepTitle = createTableCell("30%", steps.stepTitle);
      const formActionsCell = createTableCell("15%");

      const maxDescriptionLength = 100;
      const truncatedDescription =
        steps.descriptions.slice(0, maxDescriptionLength) + "...";
      const stepDescription = createTableCell("45%", truncatedDescription);

      createAndAppendButtons(
        stepDescription,
        steps.descriptions,
        truncatedDescription,
        formActionsCell,
        "btn-select-step",
        "btn-edit-step",
        "btn-delete-step"
      );

      [stepCode, stepTitle, stepDescription, formActionsCell].forEach(
        (cell) => {
          row.appendChild(cell);
        }
      );
      tableBody.appendChild(row);
    });

    initEventAddStep();
    initEventViewStep();
    initEventEditStep();
    initEventDeleteStep();
    dragDropTable();
  }

  function initEventAddStep() {
    const buttonAddStep = document.getElementById("add-forms-step");
    buttonAddStep.addEventListener("click", () => {
      openModalAddStep();

      const footerModal = document.getElementById("footer-modal-step");
      footerModal.style.display = "block";

      const buttonSaveStep = document.getElementById("save-form-new-step");

      if (!isSaveFormStepEvent) {
        isSaveFormStepEvent = true;

        buttonSaveStep.addEventListener("click", () => {
          saveNewStep();
        });
      }
    });
  }

  let arrayCodeModified = [];
  function updateStepCodes() {
    let rows = document.querySelectorAll("#table-form-steps tbody tr");
    rows.forEach((row, index) => {
      // Accediendo al stepCode directamente desde la celda td
      let stepCodeCell = row.querySelector("td");
      let newStepCode = index + 1;
      stepCodeCell.textContent = newStepCode;

      let originalStepCode = row.dataset.stepCodeOriginal;

      let correspondingObjectNewStep = stepNewObject.find(
        (item) => item.originalCode === originalStepCode
      );
      if (correspondingObjectNewStep) {
        correspondingObjectNewStep.stepCode = newStepCode.toString();
      }

      let correspondingObject = stepsEditObject.find(
        (item) => item.mySQLstepId === row.dataset.idMysql
      );
      if (correspondingObject) {
        correspondingObject.stepCode = newStepCode.toString();
      }

      if (originalStepCode != newStepCode.toString()) {
        row.dataset.statusCode = "CodeModified";

        if (row.dataset.idMysql != undefined) {
          let modification = {
            idStepMySQL: row.dataset.idMysql,
            stepCode: newStepCode.toString(),
          };
          if (
            !arrayCodeModified.some(
              (item) => item.idStepMySQL === modification.idStepMySQL
            )
          ) {
            arrayCodeModified.push(modification);
          }
        }
      } else {
        row.dataset.statusCode = "CodeOriginal";

        arrayCodeModified = arrayCodeModified.filter(
          (item) => item.idStepMySQL !== row.dataset.idMysql
        );
      }
    });
  }

  function dragDropTable() {
    let draggedItem = null;

    document.querySelectorAll("#table-form-steps tbody tr").forEach((row) => {
      row.setAttribute("draggable", true);

      // Evento cuando se inicia el arrastre
      row.addEventListener("dragstart", function (e) {
        draggedItem = this;
        setTimeout(() => {
          draggedItem.classList.add("dragging");
          draggedItem.style.opacity = "0.8"; // Ligeramente transparente
        }, 0);
      });

      // Evento cuando el elemento arrastrado es soltado
      row.addEventListener("dragend", function (e) {
        setTimeout(() => {
          draggedItem.classList.remove("dragging");
          draggedItem.style.opacity = "1"; // Restaurar opacidad
          draggedItem = null;
          updateStepCodes();
        }, 0);
      });

      // Evento necesario para permitir el drop
      row.addEventListener("dragover", function (e) {
        e.preventDefault();
        this.classList.add("highlighted"); // Resaltado de fila de destino
      });

      // Evento cuando un elemento no est√° sobre la fila
      row.addEventListener("dragleave", function (e) {
        this.classList.remove("highlighted"); // Restaurar fondo original
      });

      // Evento cuando se suelta un elemento
      row.addEventListener("drop", function (e) {
        e.preventDefault();
        this.classList.remove("highlighted"); // Restaurar fondo original

        if (draggedItem !== null) {
          this.parentNode.insertBefore(draggedItem, this);
        }
      });
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    dragDropTable();
  });
</script>
